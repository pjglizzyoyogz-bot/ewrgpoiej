-- Brainrot Detection and Discord Webhook Script (Client-side)
local HttpService = game:GetService("HttpService")
local TeleportService = game:GetService("TeleportService")
local Players = game:GetService("Players")

-- HTTP request function (compatible with most executors)
local request = syn and syn.request or http and http.request or http_request or fluxus and fluxus.request

if not request then
    error("No HTTP request function found! Make sure you're using a compatible executor.")
end

-- Discord Webhook URLs
local webhooks = {
    highValue = "https://discord.com/api/webhooks/1420571524515102731/nhtroygawwGSM2U6ZmH2fBM8s2dtAfa3kEDRR1Q7x7bTfCqrLcXh2WjCuDubxOYDxgeS", -- 10M/s to 100M/s
    secretLowValue = "https://discord.com/api/webhooks/1420571944901939320/_4eendPWSlqgeNThqRlAQG5JrOcntU3rimQ3OMfQHwOTFMDrSeE6AZInEGpOto6hAOmc", -- Secret rarity < 1M/s
    mediumValue = "https://discord.com/api/webhooks/1420572218743853076/mn436Nx8jA2kclSJgT25JzQgImM8DV0EG6OaPprHxRqubkZAMynHXIvOdytdDLcuXOgq" -- 1M/s to 10M/s
}

-- Color palette for rotating embed colors
local colors = {
    0x00ff00, -- Green
    0xff6b35, -- Orange
    0x9b59b6, -- Purple
    0x3498db, -- Blue
    0xe74c3c, -- Red
    0xf1c40f, -- Yellow
    0x1abc9c, -- Teal
    0xe67e22  -- Dark Orange
}

-- Storage for detected brainrots by category
local detectedBrainrots = {
    highValue = {},
    secretLowValue = {},
    mediumValue = {}
}

-- Function to parse price string and convert to numerical value
local function parsePrice(priceStr)
    if not priceStr then return 0 end
    
    -- Remove $ and /s at the end
    local cleanPrice = priceStr:gsub("^%$", ""):gsub("/s$", "")
    
    local multiplier = 1
    if cleanPrice:find("K$") then
        multiplier = 1000
        cleanPrice = cleanPrice:gsub("K$", "")
    elseif cleanPrice:find("M$") then
        multiplier = 1000000
        cleanPrice = cleanPrice:gsub("M$", "")
    elseif cleanPrice:find("B$") then
        multiplier = 1000000000
        cleanPrice = cleanPrice:gsub("B$", "")
    end
    
    local numValue = tonumber(cleanPrice)
    return numValue and (numValue * multiplier) or 0
end

-- Function to get random color from palette
local function getRandomColor()
    return colors[math.random(1, #colors)]
end

-- Function to get player count (excluding local player)
local function getPlayerCount()
    local count = 0
    for _, player in pairs(Players:GetPlayers()) do
        if player ~= Players.LocalPlayer then
            count = count + 1
        end
    end
    return count
end

-- Function to get max server size
local function getMaxPlayers()
    return Players.MaxPlayers or 50 -- Default to 50 if not available
end



-- Function to send category embed with all brainrots
local function sendCategoryEmbed(webhookUrl, category, brainrots)
    if #brainrots == 0 then return end
    
    print("Sending " .. category .. " embed with " .. #brainrots .. " brainrots...")
    
    local jobId = game.JobId
    local joinScript = string.format('game:GetService("TeleportService"):TeleportToPlaceInstance(109983668079237, "%s", game.Players.LocalPlayer)', jobId)
    local playerCount = getPlayerCount()
    local maxPlayers = getMaxPlayers()
    local totalPlayers = #Players:GetPlayers()
    
    -- Create title based on category
    local titles = {
        highValue = "🧠 BRAINROTS DETECTED (" .. #brainrots .. " Found)",
        secretLowValue = "🧠 SECRET BRAINROTS DETECTED (" .. #brainrots .. " Found)", 
        mediumValue = "🧠 BRAINROTS DETECTED (" .. #brainrots .. " Found)"
    }
    
    local fields = {}
    
    -- Add detected brainrots section
    table.insert(fields, {
        name = "DETECTED BRAINROTS",
        value = "",
        inline = false
    })
    
    -- Sort brainrots by value (highest first)
    table.sort(brainrots, function(a, b)
        return a.value > b.value
    end)
    
    -- Add each brainrot
    for i, brainrot in ipairs(brainrots) do
        local rarityEmoji = brainrot.rarity == "Secret" and "💎" or 
                           brainrot.rarity == "Legendary" and "🔥" or
                           brainrot.rarity == "Epic" and "⚡" or "🔸"
        
        -- Format name with or without mutation
        local nameDisplay = brainrot.mutation == "Gold" and 
            string.format("**%s**", brainrot.displayName) or
            string.format("**%s (%s)**", brainrot.displayName, brainrot.mutation)
        
        local petInfo = string.format("%s %s **%s** ➜ **%s**\nOwner: %s", 
            rarityEmoji,
            nameDisplay,
            brainrot.generation,
            brainrot.rarity,
            brainrot.owner
        )
        
        table.insert(fields, {
            name = "",
            value = petInfo,
            inline = false
        })
    end
    
    -- Add Job ID sections
    table.insert(fields, {
        name = "💻 Job ID (PC)",
        value = jobId,
        inline = true
    })
    
    table.insert(fields, {
        name = "📱 Job ID (Mobile)", 
        value = "```\n" .. jobId .. "\n```",
        inline = true
    })
    
    table.insert(fields, {
        name = "👥 Players in game:",
        value = "```\n" .. totalPlayers .. "/" .. maxPlayers .. "\n```",
        inline = true
    })
    
    -- Add Quick Join section
    local quickJoinUrl = string.format("https://fern.wtf/joiner?placeId=109983668079237&gameInstanceId=%s", jobId)
    table.insert(fields, {
        name = "🔗 Quick Join",
        value = "[Click to Join](" .. quickJoinUrl .. ")",
        inline = false
    })
    
    -- Add Join Script
    table.insert(fields, {
        name = "📜 Join Script",
        value = "```lua\n" .. joinScript .. "\n```",
        inline = false
    })
    
    local embed = {
        embeds = {{
            title = titles[category],
            color = getRandomColor(),
            fields = fields,
            footer = {
                text = "GFH Brainrot Logger Notifications 💩 | https://discord.gg/aVTyZq3hU4"
            },
            timestamp = os.date("!%Y-%m-%dT%H:%M:%SZ")
        }}
    }
    
    local data = HttpService:JSONEncode(embed)
    
    local success, response = pcall(function()
        return request({
            Url = webhookUrl,
            Method = "POST",
            Headers = {
                ["Content-Type"] = "application/json"
            },
            Body = data
        })
    end)
    
    if success then
        if response and response.Success then
            print("✅ Successfully sent " .. category .. " embed to Discord!")
        else
            warn("❌ Discord request failed: " .. (response and tostring(response.StatusCode) or "No response"))
            if response and response.Body then
                warn("Response body: " .. tostring(response.Body))
            end
        end
    else
        warn("❌ Error making request: " .. tostring(response))
    end
end

-- Function to get plot owner name
local function getPlotOwner(plot)
    local plotSign = plot:FindFirstChild("PlotSign")
    if plotSign then
        local surfaceGui = plotSign:FindFirstChild("SurfaceGui")
        if surfaceGui then
            local frame = surfaceGui:FindFirstChild("Frame")
            if frame then
                local textLabel = frame:FindFirstChild("TextLabel")
                if textLabel then
                    local fullText = textLabel.Text
                    -- Extract name from "playername's Base" format and clean it
                    local ownerName = fullText:match("(.+)'s [Bb]ase")
                    return ownerName or "Unknown"
                end
            end
        end
    end
    return "Unknown"
end

-- Function to check and process animal data
local function checkAnimal(animalOverhead, plotId, podiumNumber, plot)
    if not animalOverhead then return end
    
    local displayName = animalOverhead:FindFirstChild("DisplayName")
    local mutation = animalOverhead:FindFirstChild("Mutation")
    local generationLabel = animalOverhead:FindFirstChild("Generation")
    local rarity = animalOverhead:FindFirstChild("Rarity")
    
    if not (displayName and mutation and generationLabel and rarity) then 
        return 
    end
    
    local displayNameText = displayName.Text
    local mutationText = mutation.Text
    local generationText = generationLabel.Text
    local rarityText = rarity.Text
    
    print("Found animal: " .. displayNameText .. " | Generation: " .. generationText .. " | Rarity: " .. rarityText)
    
    local priceValue = parsePrice(generationText)
    local ownerName = getPlotOwner(plot)
    
    -- Create brainrot data
    local brainrotData = {
        displayName = displayNameText,
        mutation = mutationText,
        generation = generationText,
        rarity = rarityText,
        plotId = plotId,
        value = priceValue,
        owner = ownerName
    }
    
    -- Check conditions and add to appropriate category
    if priceValue >= 10000000 and priceValue < 100000000 then
        -- 10M/s to 100M/s
        table.insert(detectedBrainrots.highValue, brainrotData)
        print("High value brainrot detected: " .. displayNameText .. " - " .. generationText)
    elseif rarityText == "Secret" and priceValue < 1000000 then
        -- Secret rarity less than 1M/s
        table.insert(detectedBrainrots.secretLowValue, brainrotData)
        print("Secret low value brainrot detected: " .. displayNameText .. " - " .. generationText)
    elseif priceValue >= 1000000 and priceValue < 10000000 then
        -- 1M/s to 10M/s
        table.insert(detectedBrainrots.mediumValue, brainrotData)
        print("Medium value brainrot detected: " .. displayNameText .. " - " .. generationText)
    end
end

-- Smart Server Hopping System
local PlaceID = 109983668079237
local AllIDs = {}
local foundAnything = ""
local actualHour = os.date("!*t").hour
local Deleted = false

-- Load visited servers from file
local File = pcall(function()
    AllIDs = HttpService:JSONDecode(readfile("NotSameServers.json"))
end)
if not File then
    table.insert(AllIDs, actualHour)
    writefile("NotSameServers.json", HttpService:JSONEncode(AllIDs))
end

-- Function to find and teleport to a different server
function TPReturner()
    local Site;
    if foundAnything == "" then
        Site = HttpService:JSONDecode(game:HttpGet('https://games.roblox.com/v1/games/' .. PlaceID .. '/servers/Public?sortOrder=Asc&limit=100'))
    else
        Site = HttpService:JSONDecode(game:HttpGet('https://games.roblox.com/v1/games/' .. PlaceID .. '/servers/Public?sortOrder=Asc&limit=100&cursor=' .. foundAnything))
    end
    local ID = ""
    if Site.nextPageCursor and Site.nextPageCursor ~= "null" and Site.nextPageCursor ~= nil then
        foundAnything = Site.nextPageCursor
    end
    local num = 0;
    for i,v in pairs(Site.data) do
        local Possible = true
        ID = tostring(v.id)
        if tonumber(v.maxPlayers) > tonumber(v.playing) then
            for _,Existing in pairs(AllIDs) do
                if num ~= 0 then
                    if ID == tostring(Existing) then
                        Possible = false
                    end
                else
                    if tonumber(actualHour) ~= tonumber(Existing) then
                        local delFile = pcall(function()
                            delfile("NotSameServers.json")
                            AllIDs = {}
                            table.insert(AllIDs, actualHour)
                        end)
                    end
                end
                num = num + 1
            end
            if Possible == true then
                table.insert(AllIDs, ID)
                wait()
                pcall(function()
                    writefile("NotSameServers.json", HttpService:JSONEncode(AllIDs))
                    wait()
                    print("🚀 Teleporting to server: " .. ID .. " (" .. v.playing .. "/" .. v.maxPlayers .. " players)")
                    TeleportService:TeleportToPlaceInstance(PlaceID, ID, Players.LocalPlayer)
                end)
                wait(4)
                return true -- Successfully found a server
            end
        end
    end
    return false -- No suitable server found
end

-- Function to initiate server hop
function smartServerHop()
    print("🔍 Searching for available servers...")
    local attempts = 0
    local maxAttempts = 5  -- Reduced attempts to not get stuck
    
    while attempts < maxAttempts do
        attempts = attempts + 1
        print("Server search attempt " .. attempts .. "/" .. maxAttempts)
        
        local success, result = pcall(function()
            return TPReturner()
        end)
        
        if success and result then
            print("✅ Server hop initiated successfully!")
            return true
        end
        
        -- Try with next page cursor if available
        if foundAnything ~= "" then
            local success2, result2 = pcall(function()
                return TPReturner()
            end)
            if success2 and result2 then
                print("✅ Server hop initiated successfully!")
                return true
            end
        end
        
        print("❌ No suitable server found, retrying in 2 seconds...")
        wait(2)
    end
    
    print("⚠️ Could not find suitable server after " .. maxAttempts .. " attempts")
    return false
end

-- Main function to scan all plots
local function scanAllPlots()
    local plots = workspace:FindFirstChild("Plots")
    if not plots then
        warn("Plots folder not found in workspace")
        return
    end
    
    print("Starting brainrot scan...")
    
    -- Clear previous results
    detectedBrainrots.highValue = {}
    detectedBrainrots.secretLowValue = {}
    detectedBrainrots.mediumValue = {}
    
    for _, plot in pairs(plots:GetChildren()) do
        if plot:IsA("Model") then
            local plotId = plot.Name
            print("Scanning plot: " .. plotId)
            
            local animalPodiums = plot:FindFirstChild("AnimalPodiums")
            if animalPodiums then
                -- Find the highest numbered podium (up to 28)
                for i = 1, 28 do
                    local podium = animalPodiums:FindFirstChild(tostring(i))
                    if podium then
                        local base = podium:FindFirstChild("Base")
                        if base then
                            local spawn = base:FindFirstChild("Spawn")
                            if spawn then
                                local attachment = spawn:FindFirstChild("Attachment")
                                if attachment then
                                    local animalOverhead = attachment:FindFirstChild("AnimalOverhead")
                                    if animalOverhead then
                                        checkAnimal(animalOverhead, plotId, i, plot)
                                    end
                                end
                            end
                        end
                    end
                end
            end
        end
    end
    
    print("Brainrot scan completed!")
    
    -- Check if any brainrots were found
    local totalFound = #detectedBrainrots.highValue + #detectedBrainrots.secretLowValue + #detectedBrainrots.mediumValue
    
    if totalFound > 0 then
        -- Send category embeds
        print("Sending Discord embeds...")
        sendCategoryEmbed(webhooks.highValue, "highValue", detectedBrainrots.highValue)
        wait(1) -- Small delay between embeds
        sendCategoryEmbed(webhooks.secretLowValue, "secretLowValue", detectedBrainrots.secretLowValue)
        wait(1)
        sendCategoryEmbed(webhooks.mediumValue, "mediumValue", detectedBrainrots.mediumValue)
        
        print("All embeds sent!")
        print("Found " .. totalFound .. " brainrots! Server hopping...")
        
        -- Wait a bit before server hopping
        wait(3)
        
        
        -- Smart server hop
        local hopSuccess = smartServerHop()
        if not hopSuccess then
            print("⚠️ Server hop failed, continuing scan in current server...")
        end
    else
        print("No brainrots found, server hopping...")
        wait(2)
        
        
        -- Smart server hop
        local hopSuccess = smartServerHop()
        if not hopSuccess then
            print("⚠️ Server hop failed, continuing scan in current server...")
        end
    end
end

-- Function to continuously run the scanner with server hopping
local function continuousScanner()
    while true do
        local success, error = pcall(scanAllPlots)
        if not success then
            warn("Error during scan: " .. tostring(error))
            print("Retrying in 5 seconds...")
            wait(5)
        else
            print("✅ Scan completed successfully!")
        end
        
        -- Always wait before next scan (whether teleport happened or not)
        print("⏳ Waiting 5 seconds before next scan...")
        wait(5)
        
        -- Reset cursor for fresh server search
        foundAnything = ""
    end
end

-- Run the continuous scanner
continuousScanner()
